<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>

    <title>Hello, SVEEP Korea!</title>
    <link rel="icon" type="image/x-icon" href="static/images/eci-logo.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.2.6/interact.min.js"></script>


    <style>
        .image-container {
            position: relative;
            width: 100%;
            height: 0;
            padding-bottom: 100%;
            overflow: hidden;
        }

        .image1,
        .image2 {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
        }

        .image1 {
            pointer-events: none;
            z-index: 1;
        }

        .image2 {
            width: 50%;
            height: 50%;
            z-index: 0;
            pointer-events: auto;
        }
    </style>

</head>

<body class="bg-light">

    <div class="container">

        <form>

            <div class="d-flex justify-content-center image-container ">
                <div class="frame">
                    <img class="image1" id="wrapper" src="static/images/Koreaimage-4.png">
                </div>
                <img class="image2 resize-drag" id="preview" src="static/images/avatar-image.png">
            </div>

            <div class="mb-3">
                <label for="uploadImage" class="form-label">Your photo</label>
                <input type="file" class="form-control" id="uploadImage" accept="image/png, image/jpg, image/jpeg"
                    required>
            </div>

            <button type="button" class="btn btn-sm btn-primary" id="mergeAndDownload">Download</button>

        </form>

    </div>



    <script>

        let fileTag = document.getElementById("uploadImage"),
            preview = document.getElementById("preview");

        fileTag.addEventListener("change", function () {
            changeImage(this);
        });

        function changeImage(input) {
            let reader;

            if (input.files && input.files[0]) {
                reader = new FileReader();
                reader.onload = function (e) {
                    preview.setAttribute('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }




        interact('.resize-drag')
            .draggable({
                onmove: window.dragMoveListener
            })
            .resizable({
                preserveAspectRatio: true,
                edges: { left: true, right: true, bottom: true, top: true }
            })
            .on('resizemove', function (event) {
                var target = event.target,
                    x = (parseFloat(target.getAttribute('data-x')) || 0),
                    y = (parseFloat(target.getAttribute('data-y')) || 0);

                // update the element's style
                target.style.width = event.rect.width + 'px';
                target.style.height = event.rect.height + 'px';

                // translate when resizing from top or left edges
                x += event.deltaRect.left;
                y += event.deltaRect.top;

                target.style.webkitTransform = target.style.transform =
                    'translate(' + x + 'px,' + y + 'px)';

                target.setAttribute('data-x', x);
                target.setAttribute('data-y', y);
                target.textContent = event.rect.width + 'Ã—' + event.rect.height;
            });

        function dragMoveListener(event) {
            var target = event.target,
                // keep the dragged position in the data-x/data-y attributes
                x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
                y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

            // translate the element
            target.style.webkitTransform =
                target.style.transform =
                'translate(' + x + 'px, ' + y + 'px)';

            // update the posiion attributes
            target.setAttribute('data-x', x);
            target.setAttribute('data-y', y);
        }

        // -----------------------------------------------------------
        // Get references to the image elements
        const image1 = document.getElementById('wrapper');
        const image2 = document.getElementById('preview');

        // Get the canvas element
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        // Function to merge and download the images
        function mergeAndDownload() {
            // Set the canvas size to match the size of the images
            canvas.width = image1.width;
            canvas.height = image1.height;

            // Draw the first image on the canvas
            context.drawImage(image1, 0, 0);

            // Draw the second image on the canvas
            context.drawImage(image2, 0, 0, image2.width, image2.height);

            // Create a data URL from the combined canvas
            const combinedImage = canvas.toDataURL('image/png');

            // Create a download link for the combined image
            const downloadLink = document.createElement('a');
            downloadLink.href = combinedImage;
            downloadLink.download = 'combined-image.png';
            downloadLink.style.display = 'none';

            // Add the link to the document and trigger a click to download
            document.body.appendChild(downloadLink);
            downloadLink.click();

            // Clean up by removing the download link
            document.body.removeChild(downloadLink);
        }

        // Attach the click event listener to the "mergeAndDownload" button
        const mergeAndDownloadButton = document.getElementById('mergeAndDownload');
        mergeAndDownloadButton.addEventListener('click', mergeAndDownload);


    </script>
</body>

</html>